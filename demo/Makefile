CFLAGS ?= -Og -Wall
export CFLAGS
CXXFLAGS ?= -Og -Wall
export CXXFLAGS

IMAGE_BASE := local/cve-2021-3449/base
IMAGE_APACHE := local/cve-2021-3449/apache2
IMAGE_OPENSSL := local/cve-2021-3449/openssl

CONTAINER_APACHE := cve-2021-3449-apache2
CONTAINER_OPENSSL := cve-2021-3449-openssl

.PHONY: start-apache
start-apache: build-apache
	docker run -d -it --name $(CONTAINER_APACHE) --network host $(IMAGE_APACHE)
	docker logs -f $(CONTAINER_APACHE) &
	sleep 10

logs-apache:
	docker logs $(CONTAINER_APACHE)

.PHONY: stop-apache
stop-apache:
	docker container rm -f $(CONTAINER_APACHE) || true

.PHONY: build-apache
build-apache: build-base
	docker build -f apache.Dockerfile -t $(IMAGE_APACHE) --build-arg "BASE_IMAGE=$(IMAGE_BASE)" .

.PHONY: start-openssl
start-openssl: build-openssl
	docker run -d -it --name $(CONTAINER_OPENSSL) --network host $(IMAGE_OPENSSL)
	docker logs -f $(CONTAINER_OPENSSL) &
	sleep 2

logs-openssl:
	docker logs $(CONTAINER_OPENSSL)

.PHONY: stop-openssl
stop-openssl:
	docker container rm -f $(CONTAINER_OPENSSL) || true

.PHONY: build-openssl
build-openssl: build-base
	docker build -f openssl.Dockerfile -t $(IMAGE_OPENSSL) --build-arg "BASE_IMAGE=$(IMAGE_BASE)" .

.PHONY: build-base
build-base: libcrypto.so.1.1 libssl.so.1.1 openssl server.pem
	docker build -f base.Dockerfile -t $(IMAGE_BASE) .

server.pem:
	openssl req -x509 -newkey rsa:2048 -keyout ./key.pem -out ./cert.pem -days 365 -nodes -subj "/CN=dummycert/O=My Company Name/C=US"
	cat key.pem cert.pem >> server.pem
	rm key.pem cert.pem

.PHONY: clean
clean: stop-apache stop-openssl
	docker image rm -f $(IMAGE_BASE) $(IMAGE_APACHE) $(IMAGE_OPENSSL)
	rm -rf ./*.pem ./*.so* ./openssl ./openssl_dir ./openssl-1.1.1j ./openssl-1.1.1j.tar.gz ./openssl-1.1.1j.tar.gz.download

openssl libcrypto.so.1.1 libssl.so.1.1: openssl_dir/Makefile
	$(MAKE) -C openssl_dir -j4 apps/openssl libcrypto.so.1.1 libssl.so.1.1
	ln -f openssl_dir/libcrypto.so.1.1 libcrypto.so.1.1
	ln -f openssl_dir/libssl.so.1.1 libssl.so.1.1
	ln -f openssl_dir/apps/openssl openssl

openssl_dir/Makefile: openssl_dir/.downloaded
	cd openssl_dir && ./config && $(MAKE) build_generated

openssl_dir/.downloaded: openssl-1.1.1j.tar.gz
	tar -xzf openssl-1.1.1j.tar.gz
	ln -sf openssl-1.1.1j openssl_dir
	touch openssl_dir/.downloaded

openssl-1.1.1j.tar.gz: openssl-1.1.1j.tar.gz.download
	sha256sum -c openssl-1.1.1j.tar.gz.sha256sum
	ln -sf openssl-1.1.1j.tar.gz.download openssl-1.1.1j.tar.gz

openssl-1.1.1j.tar.gz.download:
	curl https://www.openssl.org/source/old/1.1.1/openssl-1.1.1j.tar.gz --output openssl-1.1.1j.tar.gz.download
